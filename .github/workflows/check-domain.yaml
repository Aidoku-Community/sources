name: Check Domains

on:
  schedule:
    - cron: "0 * * * *" # every hour
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.6.3

      - name: Run domain checker
        id: run
        env:
          EXCLUDE: ${{ vars.SCAN_SOURCES_EXCLUDE || '' }}
        run: |
          cd check-domains
          deno task start

      - name: Create issues per domain
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const data = JSON.parse(fs.readFileSync("check-domains/check-domain-output.json", "utf8"));

            const deiced = data?.deiced || {};
            const changed = data?.changed || {};

            // Helper to create issue with labels
            const createIssue = async (title, body, extraLabels = []) => {
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "open"
              });

              const exists = issues.data.find(i => i.title === title);
              if (exists) {
                console.log("Issue already exists:", title);
                return;
              }

              const labels = ["ci", "domain", ...extraLabels];

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels
              });

              console.log("Issue created:", title);
            };

            // ---- Handle deiced ----
            for (const source of Object.keys(deiced)) {
              const urls = deiced[source];
              const title = `source(${source}): domain deiced`;

              const body = [
                `## â„ï¸ Domain Deiced`,
                `**Source:** ${source}`,
                ``,
                `### URLs Checked`,
                urls.map(u => "- " + u).join("\n"),
                ``,
                `### Timestamp`,
                new Date().toISOString()
              ].join("\n");

              await createIssue(title, body, ["deiced"]);
            }

            // ---- Handle changed ----
            for (const source of Object.keys(changed)) {
              const urls = changed[source];
              const original = urls[0];
              const redirected = urls[1];

              const title = `source(${source}): changed â†’ \`${redirected}\``;

              const body = [
                `## ðŸ”€ Domain Redirect Detected`,
                `**Source:** ${source}`,
                ``,
                `### Original`,
                `- ${original}`,
                ``,
                `### Redirected To`,
                `- ${redirected}`,
                ``,
                `### Timestamp`,
                new Date().toISOString()
              ].join("\n");

              await createIssue(title, body, ["changed"]);
            }
